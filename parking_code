#include <ESP32Servo.h>

#define IR_PIN     34
#define SERVO_PIN  18
#define BUZZER_PIN 23

Servo gate;

const int CLOSE_ANGLE = 0;
const int OPEN_ANGLE  = 90;

bool gateOpen = false;
unsigned long openTime = 0;
unsigned long lastTrigger = 0;

const unsigned long OPEN_DURATION = 4000;   // gate open time (4 sec)
const unsigned long COOLDOWN_TIME = 3000;   // retrigger delay (3 sec)

void setup() {
  Serial.begin(115200);

  pinMode(IR_PIN, INPUT);
  pinMode(BUZZER_PIN, OUTPUT);

  gate.setPeriodHertz(50);
  gate.attach(SERVO_PIN, 500, 2500);

  gate.write(CLOSE_ANGLE);
  digitalWrite(BUZZER_PIN, LOW);

  Serial.println("Smart Parking Gate with Buzzer Ready");
}

void loop() {
  int irValue = digitalRead(IR_PIN);

  // Most IR sensors: LOW = object detected
  bool carDetected = (irValue == LOW);
  unsigned long now = millis();

  // Open gate when car detected
  if (!gateOpen && carDetected && (now - lastTrigger > COOLDOWN_TIME)) {
    Serial.println("Car Detected â†’ Gate OPEN + Buzzer ON");

    gate.write(OPEN_ANGLE);
    digitalWrite(BUZZER_PIN, HIGH);   // buzzer ON

    gateOpen = true;
    openTime = now;
    lastTrigger = now;
  }

  // Close gate and stop buzzer after time
  if (gateOpen && (now - openTime > OPEN_DURATION)) {
    Serial.println("Gate CLOSE + Buzzer OFF");

    gate.write(CLOSE_ANGLE);
    digitalWrite(BUZZER_PIN, LOW);    // buzzer OFF

    gateOpen = false;
  }

  delay(50);
}
